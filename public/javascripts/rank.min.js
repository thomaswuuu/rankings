const spinner=document.querySelector("#spinner"),platforms=document.querySelector("#platforms"),charts=document.querySelector("#charts"),tracks=document.querySelector("#tracks"),previewKKBOX=document.querySelector("#previewKKBOX"),previewSpotify=document.querySelector("#previewSpotify"),kkboxes=document.querySelectorAll(".kkbox"),spotifies=document.querySelectorAll(".spotify");let previewSpotifyController;const closePreview=()=>{previewKKBOX.setAttribute("src",""),previewSpotify.querySelector("iframe").setAttribute("src","")},queryPreview=e=>{let t=document.querySelector(".modal-title"),r=e.parentNode,l=r.querySelector(".title a").innerText,s=r.querySelector(".artist").innerText,a=e.dataset.id,i=e.dataset.type,o="";t.style.width="100%",t.innerHTML=`${s} - ${l} `,"KKBOX"==i?(o=`https://widget.kkbox.com/v1/?id=${a}&autoplay=true&type=song&terr=TW&lang=TC&loop=false`,previewKKBOX.style.display="block",previewSpotify.style.display="none",previewKKBOX.setAttribute("height","100px"),previewKKBOX.setAttribute("src",o)):(previewKKBOX.style.display="none",previewSpotify.style.display="block",previewSpotifyController.loadUri(`spotify:track:${a}`),previewSpotifyController.play());let c=document.querySelector("#previewClose");c.addEventListener("click",()=>{closePreview()});let n=document.querySelector("#previewModal");n.addEventListener("click",()=>{closePreview()})},queryTracks=e=>{let t=e.dataset.type,r=e.dataset.id,l=e.childNodes[1].src,s=e.childNodes[3].innerText,a="KKBOX"==t?"kkbox-border":"spotify-border",i=new MusicsHub(t,r),o=i.data;spinner.style.display="flex",platforms.style.display="none",charts.style.display="none",tracks.style.display="none",o.then(e=>{if(e.length){tracks.innerHTML=`<h4>
                            <img src="${l}"/>
                            <span>${t} ${s}</span>
                          </h4>`,e.forEach(e=>{let r=e.track_id,l=e.rankNo,s=e.title,i=e.album,o=e.artist,c=e.titleLink,n=e.albumLink,p=e.artistLink,d=e.cover,y=e.release_date;tracks.innerHTML+=`<div class="track-box ${a} fade-in">
                              <p>${l}</p>
                              <img src=${d} />
                              <div class="title">
                                <a href="${c}" target="_blank">${s}</a>
                                <div class="artist">
                                  <a href="${p}" target="_blank">${o}</a>
                                </div>
                              </div>
                              <div class="album">
                                <a href="${n}" target="_blank">${i}</a>
                              </div>
                              <div class="date">${y}</div>
                              <div class="preview"
                                    data-bs-toggle="modal"
                                    data-type="${t}" data-id="${r}"
                                    data-bs-target="#previewModal">
                                試聽
                              </div>
                            </div>`}),tracks.innerHTML+=`<p class="back">返回排行榜列表</p>`;let r=document.querySelectorAll(".preview");r.forEach(e=>{e.addEventListener("click",()=>{queryPreview(e)})});let i=document.querySelector(".back");i.addEventListener("click",()=>{charts.style.display="flex",tracks.style.display="none",i.style.display="none",window.location.href="#charts"}),spinner.style.display="none",tracks.style.display="flex"}})},queryCharts=e=>{let t=e.dataset.type,r=new MusicsHub(t,null),l=r.data,s=document.querySelector("#collapsibleNavbar"),a="KKBOX"==t?"kkbox-border":"spotify-border";s.classList.remove("show"),spinner.style.display="flex",platforms.style.display="none",charts.style.display="none",tracks.style.display="none",l.then(e=>{if(e.length){charts.innerHTML=`<h4>
                              <span>${t} 排行榜列表</span>
                            </h4>`,e.forEach(e=>{let r=e.title;charts.innerHTML+=`<div class="chart-box ${a} fade-in"
                                data-type="${t}"
                                data-id="${e.id}">
                                <img src="${e.cover}" />
                                <p>${r}</p>
                              </div>`});let r=document.querySelectorAll(".chart-box");r.forEach(e=>{e.addEventListener("click",()=>{queryTracks(e)})}),spinner.style.display="none",charts.style.display="flex"}}).catch(e=>{console.log(e)})};kkboxes.forEach(e=>{e.addEventListener("click",()=>{queryCharts(e)})}),spotifies.forEach(e=>{e.addEventListener("click",()=>{queryCharts(e)})}),window.onSpotifyIframeApiReady=e=>{let t=document.getElementById("embed-iframe"),r={width:"100%",height:"180"},l=e=>{previewSpotifyController=e};e.createController(t,r,l)};let prevScrollpos=window.scrollY;window.addEventListener("scroll",()=>{let e=window.scrollY,t=document.querySelector("header");prevScrollpos>=e||e<=20?t.style.top="0":t.style.top="-20vh",prevScrollpos=e});